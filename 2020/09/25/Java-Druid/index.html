<!DOCTYPE html>
<html  lang="english" >
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>Java-Druid | Tukekenulia</title>
    <meta name="description" content="1-Spring Boot 集成 Druid 监控数据源Druid 首先是一个数据库连接池，但它不仅仅是一个数据库连接池，还包含了一个 ProxyDriver，一系列内置的 JDBC 组件库，一个 SQL Parser。在 Java 的世界中 Druid 是监控做的最好的数据库连接池，在功能、性能、扩展性方面，也有不错的表现。 Druid 功能  替换其他 Java 连接池，Druid 提供了">
<meta property="og:type" content="article">
<meta property="og:title" content="Java-Druid">
<meta property="og:url" content="http://yoursite.com/2020/09/25/Java-Druid/index.html">
<meta property="og:site_name" content="Tukekenulia">
<meta property="og:description" content="1-Spring Boot 集成 Druid 监控数据源Druid 首先是一个数据库连接池，但它不仅仅是一个数据库连接池，还包含了一个 ProxyDriver，一系列内置的 JDBC 组件库，一个 SQL Parser。在 Java 的世界中 Druid 是监控做的最好的数据库连接池，在功能、性能、扩展性方面，也有不错的表现。 Druid 功能  替换其他 Java 连接池，Druid 提供了">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/images/Java-Druid/1.png">
<meta property="og:image" content="http://yoursite.com/images/Java-Druid/2.png">
<meta property="og:image" content="http://yoursite.com/images/Java-Druid/3.png">
<meta property="article:published_time" content="2020-09-25T07:48:02.000Z">
<meta property="article:modified_time" content="2023-08-12T04:21:49.929Z">
<meta property="article:author" content="Tukeke">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/Java-Druid/1.png">

    
    <link rel="icon" href="images/icon.png" type="image/x-icon">

    
<link rel="stylesheet" href="/css/common.min.css">



    
    
    
    
        <link href="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/css/lightgallery.min.css" rel="stylesheet">
    
    
    
<link rel="stylesheet" href="/css/iconfont.min.css">

    
<meta name="generator" content="Hexo 6.3.0"></head>

    <body>
        <header class="header header-fixture">
    <div class="profile-search-wrap flex sm:block">
        
        
        <div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6">
            <a id="avatar" role="link" href="https://github.com/" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer" >
                <img src="https://www.gravatar.com/avatar/0bc83cb571cd1c50ba6f3e8a78ef1346?s=128" class="rounded-full" alt="avatar">
            </a>
            <h2 id="name" class="hidden lg:block">Tukeke</h2>
            <h3 id="title" class="hidden lg:block">Student &amp; Coder</h3>
            
            <small id="location" class="hidden lg:block">
                <i class="iconfont icon-map-icon"></i>
                Wenzhou, China
            </small>
            
        </div>
        
        
<div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full">
    <form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200">
        <div class="input-group table bg-gray-100 lg:bg-white w-full">
            <input id="search-input" type="text" placeholder="Search" class="inline-block w-full bg-gray-100 lg:bg-white p-1">
            <span class="table-cell">
                <button name="search tigger button" disabled>
                    <i class="iconfont icon-search m-2"></i>
                </button>
            </span>
        </div>
    </form>
        
<div id="content-json" data-placeholder="Search" class="invisible hidden">/content.json</div>
<script id="search-teamplate" type="text/html" data-path="/content.json">
    <div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="Search" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div>
</script>

</div>


        <button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false">
            <i class="iconfont icon-hamburger"></i>
        </button>
    </div>
    <nav id="menu-nav" class="hidden sm:flex flex-col">
        
        
            <div class="menu-item menu-home" role="menuitem">
                <a href="/.">
                    <i class="iconfont icon-home" aria-hidden="true"></i>
                    <span class="menu-title">Home</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-archives" role="menuitem">
                <a href="/archives">
                    <i class="iconfont icon-archive" aria-hidden="true"></i>
                    <span class="menu-title">Archives</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-categories" role="menuitem">
                <a href="/categories">
                    <i class="iconfont icon-folder" aria-hidden="true"></i>
                    <span class="menu-title">Categories</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-tags" role="menuitem">
                <a href="/tags">
                    <i class="iconfont icon-tag" aria-hidden="true"></i>
                    <span class="menu-title">Tags</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-repository" role="menuitem">
                <a href="/repository">
                    <i class="iconfont icon-project" aria-hidden="true"></i>
                    <span class="menu-title">Repository</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-links" role="menuitem">
                <a href="/links">
                    <i class="iconfont icon-friend" aria-hidden="true"></i>
                    <span class="menu-title">Links</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-about" role="menuitem">
                <a href="/about">
                    <i class="iconfont icon-cup" aria-hidden="true"></i>
                    <span class="menu-title">About</span>
                </a>
            </div>
        
        
<div class="social-links flex sm:flex-col lg:hidden mt-5">
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://github.com/">
                <i class="iconfont social-icon icon-github"></i>
                <span class="menu-title hidden lg:inline">menu.github</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://t.me/">
                <i class="iconfont social-icon icon-telegram"></i>
                <span class="menu-title hidden lg:inline">menu.telegram</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://twitter.com/example">
                <i class="iconfont social-icon icon-twitter"></i>
                <span class="menu-title hidden lg:inline">menu.twitter</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a href="/atom.xml">
                <i class="iconfont social-icon icon-rss"></i>
                <span class="menu-title hidden lg:inline">menu.rss</span>
            </a>
        </span>
    
</div>


    </nav>
</header>

        <section class="main-section">
            
    <main class="flex-1 px-4 py-14 md:px-5 lg:px-8 lg:py-4 relative min-h-screen">
    

    <article class="content article article-archives article-type-list" itemscope="">
        <header class="article-header">
            
    
        <h1 class="article-title text-lg" itemprop="name">
            Java-Druid
        </h1>
    



            <p class="article-meta mb-3 text-xs">
                <span class="article-date">
    <i class="iconfont icon-calendar-check"></i>
	<a href="/2020/09/25/Java-Druid/" class="article-date">
	  <time datetime="2020-09-25T07:48:02.000Z" itemprop="datePublished">Sep 25</time>
	</a>
</span>

                

                

                <span class="_partial/post-comment"><i class="icon icon-comment"></i>
                    <a href="/2020/09/25/Java-Druid/#comments" class="article-comment-link">
                        Comments
                    </a>
                </span>
                

            </p>
        </header>
        <div class="marked-body article-body">
            <span id="more"></span>

<h2 id="1-Spring-Boot-集成-Druid-监控数据源"><a href="#1-Spring-Boot-集成-Druid-监控数据源" class="headerlink" title="1-Spring Boot 集成 Druid 监控数据源"></a>1-Spring Boot 集成 Druid 监控数据源</h2><p>Druid 首先是一个数据库连接池，但它不仅仅是一个数据库连接池，还包含了一个 ProxyDriver，一系列内置的 JDBC 组件库，一个 SQL Parser。在 Java 的世界中 Druid 是监控做的最好的数据库连接池，在功能、性能、扩展性方面，也有不错的表现。</p>
<p><strong>Druid 功能</strong></p>
<ul>
<li>替换其他 Java 连接池，Druid 提供了一个高效、功能强大、可扩展性好的数据库连接池。</li>
<li>可以监控数据库访问性能，Druid 内置提供了一个功能强大的 StatFilter 插件，能够详细统计 SQL 的执行性能，这对于线上分析数据库访问性能有很大帮助。</li>
<li>数据库密码加密。直接把数据库密码写在配置文件中，这是不好的行为，容易导致安全问题，DruidDruiver 和 DruidDataSource 都支持 PasswordCallback。</li>
<li>SQL 执行日志，Druid 提供了不同的 LogFilter，能够支持 Common-Logging、Log4j 和 JdkLog，可以按需要选择相应的 LogFilter，监控应用的数据库访问情况。</li>
<li>扩展 JDBC，如果你要对 JDBC 层有编程的需求，可以通过 Druid 提供的 Filter 机制，很方便编写 JDBC 层的扩展插件。</li>
</ul>
<h3 id="MyBatis-中使用-Druid-作为连接池"><a href="#MyBatis-中使用-Druid-作为连接池" class="headerlink" title="MyBatis 中使用 Druid 作为连接池"></a>MyBatis 中使用 Druid 作为连接池</h3><p><strong>引入依赖包</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-entitymanager<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>application 配置</strong></p>
<p>Druid Spring Boot Starter 配置属性的名称完全遵照 Druid，可以通过 Spring Boot 配置文件来配置 Druid 数据库连接池和监控，如果没有配置则使用默认值。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实体类包路径</span></span><br><span class="line"><span class="attr">mybatis.type-aliases-package</span>=<span class="string">com.neo.model</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.datasource.type</span>: <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/test?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 初始化大小、最小、最大连接数</span></span><br><span class="line"><span class="attr">spring.datasource.druid.initial-size</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.datasource.druid.min-idle</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.datasource.druid.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 配置获取连接等待超时的时间</span></span><br><span class="line"><span class="attr">spring.datasource.druid.max-wait</span>=<span class="string">60000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 监控后台账号和密码</span></span><br><span class="line"><span class="attr">spring.datasource.druid.stat-view-servlet.login-username</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.datasource.druid.stat-view-servlet.login-password</span>=<span class="string">admin</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 配置 StatFilter</span></span><br><span class="line"><span class="attr">spring.datasource.druid.filter.stat.log-slow-sql</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.datasource.druid.filter.stat.slow-sql-millis</span>=<span class="string">2000</span></span><br></pre></td></tr></table></figure>

<p>配置完成后，直接启动项目访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/druid">http://localhost:8080/druid</a></p>
<p><img src="/images/Java-Druid/1.png" alt="1"></p>
<h3 id="MyBatis-Druid-多数据源"><a href="#MyBatis-Druid-多数据源" class="headerlink" title="MyBatis + Druid 多数据源"></a>MyBatis + Druid 多数据源</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.druid.one.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.url</span> = <span class="string">jdbc:mysql://localhost:3306/test1?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.username</span> = <span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.password</span> = <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.datasource.druid.two.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.url</span> = <span class="string">jdbc:mysql://localhost:3306/test2?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.username</span> = <span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.password</span> = <span class="string">root</span></span><br><span class="line"><span class="attr">复制</span></span><br></pre></td></tr></table></figure>

<p>第一个数据源以 spring.datasource.druid.one.* 为前缀连接数据库 test1，第二个数据源以 spring.datasource.druid.two.* 为前缀连接数据库 test2。</p>
<p><strong>强烈注意：Spring Boot 2.X 版本不再支持配置继承，多数据源的话每个数据源的所有配置都需要单独配置，否则配置不会生效。</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  StatViewServlet 配置</span></span><br><span class="line"><span class="attr">spring.datasource.druid.stat-view-servlet.login-username</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.datasource.druid.stat-view-servlet.login-password</span>=<span class="string">admin</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 配置 StatFilter</span></span><br><span class="line"><span class="attr">spring.datasource.druid.filter.stat.log-slow-sql</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.datasource.druid.filter.stat.slow-sql-millis</span>=<span class="string">2000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Druid 数据源 1 配置</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.initial-size</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.min-idle</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.max-wait</span>=<span class="string">60000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Druid 数据源 2 配置</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.initial-size</span>=<span class="string">6</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.min-idle</span>=<span class="string">6</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.max-active</span>=<span class="string">20</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.max-wait</span>=<span class="string">120000</span></span><br><span class="line"><span class="attr">复制</span></span><br></pre></td></tr></table></figure>

<p>filter 和 stat 作为 Druid 的公共信息配置，其他数据源的配置需要各个数据源单独配置。</p>
<h4 id="注入多数据源"><a href="#注入多数据源" class="headerlink" title="注入多数据源"></a>注入多数据源</h4><p>首先为两个数据源创建不同的 Mapper 包路径，将以前的 UserMapper 复制到包 com.neo.mapper.one 和 com.neo.mapper.two 路径下，并且分别重命名为 UserOneMapper、UserTwoMapper。</p>
<p>定义一个 MultiDataSourceConfig 类，对两个不同的数据源进行加载：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiDataSourceConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;oneDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.druid.one&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSourceOne</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean(name = &quot;twoDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.druid.two&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSourceTwo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制</span><br></pre></td></tr></table></figure>

<p>必须指明一个为默认的主数据源，使用注解：@Primary。加载配置两个数据源的 DataSourceConfig 和前面课程中 MyBatis 多数据源使用的配置一致没有变化。</p>
<blockquote>
<p>注意：在多数据源的情况下，我们不需要再启动类添加 @MapperScan(“com.xxx.mapper”) 的注解。</p>
</blockquote>
<h4 id="测试使用"><a href="#测试使用" class="headerlink" title="测试使用"></a>测试使用</h4><p>以上所有的配置内容都完成后，启动项目访问这个地址：<a target="_blank" rel="noopener" href="http://localhost:8080/druid%EF%BC%8C%E5%8D%95%E5%87%BB%E6%95%B0%E6%8D%AE%E6%BA%90%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF%E3%80%82">http://localhost:8080/druid，单击数据源查看数据库连接信息。</a></p>
<p>如果数据源没有信息，先访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/getUsers%EF%BC%8C%E7%94%A8%E6%9D%A5%E8%A7%A6%E5%8F%91%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E3%80%82%E5%9C%A8%E6%B2%A1%E6%9C%89">http://localhost:8080/getUsers，用来触发数据库连接。在没有</a> SQL 使用的情况下，页面监控不到数据源的配置信息，SQL 监控页面也监控不到 SQL 的执行。</p>
<p><img src="/images/Java-Druid/2.png" alt="2"></p>
<p>出现这样的画面说明配置信息已经生效，说明druid只需要经过简单的配置就能使用它强大的功能。</p>
<h3 id="Spring-Data-JPA-中使用-Druid-作为连接池"><a href="#Spring-Data-JPA-中使用-Druid-作为连接池" class="headerlink" title="Spring Data JPA 中使用 Druid 作为连接池"></a>Spring Data JPA 中使用 Druid 作为连接池</h3><p>Spring Data JPA 集成 Druid 的方式和 MyBatis 大体相同。</p>
<p>引入相关依赖包：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加 Web 依赖是因为需要在启动的时候保持容器运行，同时在项目中添加了 Web 访问，内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getUsers&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;User&gt; users=userRepository.findAll();</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Application 中添加以下信息：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化大小、最小、最大链接数</span></span><br><span class="line"><span class="attr">spring.datasource.druid.initial-size</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.datasource.druid.min-idle</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.datasource.druid.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 配置获取连接等待超时的时间</span></span><br><span class="line"><span class="attr">spring.datasource.druid.max-wait</span>=<span class="string">60000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#  StatViewServlet 配置</span></span><br><span class="line"><span class="attr">spring.datasource.druid.stat-view-servlet.login-username</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.datasource.druid.stat-view-servlet.login-password</span>=<span class="string">admin</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 配置 StatFilter</span></span><br><span class="line"><span class="attr">spring.datasource.druid.filter.stat.log-slow-sql</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.datasource.druid.filter.stat.slow-sql-millis</span>=<span class="string">2000</span></span><br></pre></td></tr></table></figure>

<p>。启动项目先访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/getUsers%EF%BC%8C%E5%86%8D%E8%AE%BF%E9%97%AE">http://localhost:8080/getUsers，再访问</a> <a target="_blank" rel="noopener" href="http://localhost:8080/druid%EF%BC%8C%E6%9F%A5%E7%9C%8B">http://localhost:8080/druid，查看</a> SQL 执行记录</p>
<p><img src="/images/Java-Druid/3.png" alt="3"></p>
<p>会发现有 create table addres… 和 drop table if exist… 这样的 SQL 语句，这是因为我们将 JPA 的策略设置为 create，spring.jpa.properties.hibernate.hbm2ddl.auto&#x3D;create，意味着每次重启的时候对会重新创建表，方便我们在测试的时候使用。</p>
<h3 id="JPA-Druid-多数据源"><a href="#JPA-Druid-多数据源" class="headerlink" title="JPA + Druid + 多数据源"></a>JPA + Druid + 多数据源</h3><h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;dependency&gt;</span></span><br><span class="line"><span class="comment">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">    &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">    &lt;version&gt;1.1.10&lt;/version&gt;</span></span><br><span class="line"><span class="comment">&lt;/dependency&gt;--&gt;</span></span><br></pre></td></tr></table></figure>

<p>删掉对 druid-spring-boot-starter 包的依赖，添加 Druid 的依赖包，添加 log4j 的原因是因为 Druid 依赖于 log4j 打印日志。</p>
<h4 id="多数据源配置"><a href="#多数据源配置" class="headerlink" title="多数据源配置"></a>多数据源配置</h4><p>配置文件我们做这样的设计，将多个数据源相同配置抽取出来共用，每个数据源个性配置信息单独配置。</p>
<p>数据库1的配置，以 spring.datasource.druid.one 开头：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.druid.one.url</span>=<span class="string">jdbc:mysql://localhost:3306/test1?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.initialSize</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.minIdle</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.datasource.druid.one.maxActive</span>=<span class="string">10</span></span><br></pre></td></tr></table></figure>

<p>数据库2的配置，以 spring.datasource.druid.two 开头：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.druid.two.url</span>=<span class="string">jdbc:mysql://localhost:3306/test2?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.initialSize</span>=<span class="string">6</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.minIdle</span>=<span class="string">20</span></span><br><span class="line"><span class="attr">spring.datasource.druid.two.maxActive</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>

<p>多数据源的共同配置，以 spring.datasource.druid 开头，是多个数据源的公共配置项。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">配置获取连接等待超时的时间</span></span><br><span class="line"><span class="attr">spring.datasource.druid.maxWait</span>=<span class="string">60000</span></span><br><span class="line"><span class="comment">#配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span></span><br><span class="line"><span class="attr">spring.datasource.druid.timeBetweenEvictionRunsMillis</span>=<span class="string">60000</span></span><br><span class="line"><span class="comment">#配置一个连接在池中最小生存的时间，单位是毫秒</span></span><br><span class="line"><span class="attr">spring.datasource.druid.minEvictableIdleTimeMillis</span>=<span class="string">600000</span></span><br><span class="line"><span class="attr">spring.datasource.druid.maxEvictableIdleTimeMillis</span>=<span class="string">900000</span></span><br><span class="line"><span class="attr">spring.datasource.druid.validationQuery</span>=<span class="string">SELECT 1 FROM DUAL</span></span><br><span class="line"><span class="comment">#y检测连接是否有效</span></span><br><span class="line"><span class="attr">spring.datasource.druid.testWhileIdle</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#是否在从池中取出连接前进行检验连接池的可用性</span></span><br><span class="line"><span class="attr">spring.datasource.druid.testOnBorrow</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#是否在归还到池中前进行检验连接池的可用性</span></span><br><span class="line"><span class="attr">spring.datasource.druid.testOnReturn</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 是否打开 PSCache，</span></span><br><span class="line"><span class="attr">spring.datasource.druid.poolPreparedStatements</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#并且指定每个连接上 PSCache 的大小</span></span><br><span class="line"><span class="attr">spring.datasource.druid.maxPoolPreparedStatementPerConnectionSize</span>=<span class="string">20</span></span><br><span class="line"><span class="comment">#配置监控统计拦截的 filters</span></span><br><span class="line"><span class="attr">spring.datasource.druid.filters</span>=<span class="string">stat,wall,log4j</span></span><br><span class="line"><span class="comment">#通过 connectProperties 属性来打开 mergeSQL 功能，慢 SQL 记录</span></span><br><span class="line"><span class="attr">spring.datasource.druid.connectionProperties</span>=<span class="string">druid.stat.mergeSql=true;druid.stat.slowSqlMillis=600</span></span><br></pre></td></tr></table></figure>

<p>我们定义一个 DruidConfig 来加载所有的公共配置项，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix=&quot;spring.datasource.druid&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DruidConfig</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> String url;</span><br><span class="line">    <span class="keyword">protected</span> String username;</span><br><span class="line">    <span class="keyword">protected</span> String password;</span><br><span class="line">    <span class="keyword">protected</span> String driverClassName;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> initialSize;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> minIdle;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> maxActive;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> maxWait;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> timeBetweenEvictionRunsMillis;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">long</span> minEvictableIdleTimeMillis;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">long</span> maxEvictableIdleTimeMillis;</span><br><span class="line">    <span class="keyword">protected</span> String validationQuery;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> testWhileIdle;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> testOnBorrow;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> testOnReturn;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> poolPreparedStatements;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> maxPoolPreparedStatementPerConnectionSize;</span><br><span class="line">    <span class="keyword">protected</span> String filters;</span><br><span class="line">    <span class="keyword">protected</span> String connectionProperties;</span><br><span class="line">    <span class="comment">// 省略 getter setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再定义一个 DruidOneConfig 来加载数据源 1 的配置项，并继承 DruidConfig：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix=&quot;spring.datasource.druid.one&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DruidOneConfig</span>  <span class="keyword">extends</span>  <span class="title class_">DruidConfig</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> initialSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> minIdle;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxActive;</span><br><span class="line">    <span class="comment">// 省略 getter setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DruidTwoConfig和one完全一致。</p>
<h4 id="启动时加载"><a href="#启动时加载" class="headerlink" title="启动时加载"></a>启动时加载</h4><p>创建类 DruidDBConfig 在启动的时候注入配置的多数据源信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DruidDBConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DruidConfig druidOneConfig;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DruidConfig druidTwoConfig;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DruidConfig druidConfig;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在类中创建 initDruidDataSource() 方法，初始化 Druid 数据源各属性。各个数据库的个性化配置从 config 对读取，公共配置项从 druidConfig 对象获取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> DruidDataSource <span class="title function_">initDruidDataSource</span><span class="params">(DruidConfig config)</span> &#123;</span><br><span class="line">    <span class="type">DruidDataSource</span> <span class="variable">datasource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line"></span><br><span class="line">    datasource.setUrl(config.getUrl());</span><br><span class="line">    datasource.setUsername(config.getUsername());</span><br><span class="line">    datasource.setPassword(config.getPassword());</span><br><span class="line">    datasource.setDriverClassName(config.getDriverClassName());</span><br><span class="line">    datasource.setInitialSize(config.getInitialSize());</span><br><span class="line">    datasource.setMinIdle(config.getMinIdle());</span><br><span class="line">    datasource.setMaxActive(config.getMaxActive());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// common config</span></span><br><span class="line">    datasource.setMaxWait(druidConfig.getMaxWait());</span><br><span class="line">    datasource.setTimeBetweenEvictionRunsMillis(druidConfig.getTimeBetweenEvictionRunsMillis());</span><br><span class="line">    datasource.setMinEvictableIdleTimeMillis(druidConfig.getMinEvictableIdleTimeMillis());</span><br><span class="line">    datasource.setMaxEvictableIdleTimeMillis(druidConfig.getMaxEvictableIdleTimeMillis());</span><br><span class="line">    datasource.setValidationQuery(druidConfig.getValidationQuery());</span><br><span class="line">    datasource.setTestWhileIdle(druidConfig.isTestWhileIdle());</span><br><span class="line">    datasource.setTestOnBorrow(druidConfig.isTestOnBorrow());</span><br><span class="line">    datasource.setTestOnReturn(druidConfig.isTestOnReturn());</span><br><span class="line">    datasource.setPoolPreparedStatements(druidConfig.isPoolPreparedStatements());</span><br><span class="line">    datasource.setMaxPoolPreparedStatementPerConnectionSize(druidConfig.getMaxPoolPreparedStatementPerConnectionSize());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        datasource.setFilters(druidConfig.getFilters());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;druid configuration initialization filter : &#123;0&#125;&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    datasource.setConnectionProperties(druidConfig.getConnectionProperties());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> datasource;</span><br><span class="line">&#125;</span><br><span class="line">复制</span><br></pre></td></tr></table></figure>

<p>启动时调用 initDruidDataSource() 方法构建不同的数据源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;primaryDataSource&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> initDruidDataSource(druidOneConfig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(name = &quot;secondaryDataSource&quot;)</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">secondaryDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> initDruidDataSource(druidTwoConfig);</span><br><span class="line">&#125;</span><br><span class="line">复制</span><br></pre></td></tr></table></figure>

<p>下面通过不同的数据源构建 entityManager，最后注入到 Repository 的逻辑和以前一样，变化的地方只是在数据源构建和开启监控页面。</p>
<h4 id="开启监控页面"><a href="#开启监控页面" class="headerlink" title="开启监控页面"></a>开启监控页面</h4><p>因为我们使用了原生的 Druid 包，因此需要手动开启监控、配置统计相关内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DruidConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServletRegistrationBean&lt;StatViewServlet&gt; <span class="title function_">druidStatViewServlet</span><span class="params">()</span> &#123;</span><br><span class="line">        ServletRegistrationBean&lt;StatViewServlet&gt; servletRegistrationBean = <span class="keyword">new</span> <span class="title class_">ServletRegistrationBean</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">StatViewServlet</span>(), <span class="string">&quot;/druid/*&quot;</span>);</span><br><span class="line">        servletRegistrationBean.addInitParameter(<span class="string">&quot;loginUsername&quot;</span>, <span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        servletRegistrationBean.addInitParameter(<span class="string">&quot;loginPassword&quot;</span>, <span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        servletRegistrationBean.addInitParameter(<span class="string">&quot;resetEnable&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> servletRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean&lt;WebStatFilter&gt; <span class="title function_">druidStatFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        FilterRegistrationBean&lt;WebStatFilter&gt; filterRegistrationBean = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">WebStatFilter</span>());</span><br><span class="line">        filterRegistrationBean.setName(<span class="string">&quot;DruidWebStatFilter&quot;</span>);</span><br><span class="line">        filterRegistrationBean.addUrlPatterns(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        filterRegistrationBean.addInitParameter(<span class="string">&quot;exclusions&quot;</span>, <span class="string">&quot;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> filterRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完成后，重启启动项目访问地址 <a target="_blank" rel="noopener" href="http://localhost:8080/druid/sql.html%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E6%9C%89%E4%B8%A4%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84">http://localhost:8080/druid/sql.html就可以看到有两个数据源的</a> SQL 操作语句</p>

        </div>
        
<blockquote class="copyright">
    <p><strong>本文链接 : </strong><a class="permalink" href="http://yoursite.com/2020/09/25/Java-Druid/">http://yoursite.com/2020/09/25/Java-Druid/</a></p>
    <p><strong>This article is available under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a> License</strong></p>
</blockquote>


    </article>
    
    <section id="comments">
        
    </section>


    

</main>


<aside style="" id="sidebar" class="aside aside-fixture">
    <div class="toc-sidebar">
        <nav id="toc" class="article-toc">
            <h3 class="toc-title">Catalogue</h3>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Spring-Boot-%E9%9B%86%E6%88%90-Druid-%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">1.</span> <span class="toc-text">1-Spring Boot 集成 Druid 监控数据源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MyBatis-%E4%B8%AD%E4%BD%BF%E7%94%A8-Druid-%E4%BD%9C%E4%B8%BA%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">1.1.</span> <span class="toc-text">MyBatis 中使用 Druid 作为连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyBatis-Druid-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">1.2.</span> <span class="toc-text">MyBatis + Druid 多数据源</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">1.2.2.</span> <span class="toc-text">注入多数据源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.3.</span> <span class="toc-text">测试使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Data-JPA-%E4%B8%AD%E4%BD%BF%E7%94%A8-Druid-%E4%BD%9C%E4%B8%BA%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">1.3.</span> <span class="toc-text">Spring Data JPA 中使用 Druid 作为连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JPA-Druid-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">1.4.</span> <span class="toc-text">JPA + Druid + 多数据源</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">1.4.1.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.2.</span> <span class="toc-text">多数据源配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%97%B6%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.4.3.</span> <span class="toc-text">启动时加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E7%9B%91%E6%8E%A7%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.4.4.</span> <span class="toc-text">开启监控页面</span></a></li></ol></li></ol></li></ol>
        </nav>
    </div>
</aside>





        </section>
        <footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40">
    
    <div class="footer-social-links">
        
            <a target="_blank" rel="noopener" href="https://github.com/">
                <i class="iconfont icon-github"></i>
            </a>
        
            <a target="_blank" rel="noopener" href="https://t.me/">
                <i class="iconfont icon-telegram"></i>
            </a>
        
            <a target="_blank" rel="noopener" href="https://twitter.com/example">
                <i class="iconfont icon-twitter"></i>
            </a>
        
            <a href="/atom.xml">
                <i class="iconfont icon-rss"></i>
            </a>
        
    </div>
    
    
</footer>

        <div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div>
        <div id="search-view-container" class="hidden shadow-xl"></div>
        
<script src="/js/dom-event.min.js"></script>



<script src="/js/local-search.min.js"></script>



    <script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script>
    
<script src="/js/light-gallery.min.js"></script>






    </body>
</html>
